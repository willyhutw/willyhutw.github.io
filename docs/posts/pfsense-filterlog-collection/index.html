<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:1.1rem}</style><title>pfSense Filterlog Collection</title><meta name=description content=" p f S e n s e r s y s l o g f l u e L n o t k w d i r i t e d a t a s o u r c e G r a f a n a Introduction This post is about pfSense syslog(especially to ‚Ä¶"><meta name=keywords content='pfsense,syslog,fluentd,loki,grafana'><meta property="og:url" content="https://www.willyhu.tw/posts/pfsense-filterlog-collection/"><meta property="og:type" content="website"><meta property="og:title" content="pfSense Filterlog Collection"><meta property="og:description" content=" p f S e n s e r s y s l o g f l u e L n o t k w d i r i t e d a t a s o u r c e G r a f a n a Introduction This post is about pfSense syslog(especially to ‚Ä¶"><meta property="og:image" content="https://www.willyhu.tw/"><meta property="og:image:secure_url" content="https://www.willyhu.tw/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="pfSense Filterlog Collection"><meta name=twitter:description content=" p f S e n s e r s y s l o g f l u e L n o t k w d i r i t e d a t a s o u r c e G r a f a n a Introduction This post is about pfSense syslog(especially to ‚Ä¶"><meta property="twitter:domain" content="https://www.willyhu.tw/posts/pfsense-filterlog-collection/"><meta property="twitter:url" content="https://www.willyhu.tw/posts/pfsense-filterlog-collection/"><meta name=twitter:image content="https://www.willyhu.tw/"><link rel=canonical href=https://www.willyhu.tw/posts/pfsense-filterlog-collection/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.7136b4abac7b277aba8bc933917f4602d39a5c44f5590be687244bc86ef4f162.js integrity="sha256-cTa0q6x7J3q6i8kzkX9GAtOaXET1WQvmhyRLyG708WI="></script><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèñÔ∏è</text></svg>"></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=https://www.willyhu.tw/>Hello World</a></div><div class=nav-links><div class=nav-link><a href=https://www.willyhu.tw/posts/ aria-label=posts>Posts</a></div><div class=nav-link><a href=https://www.willyhu.tw/tags/ aria-label=tags>Tags</a></div><div class=nav-link><a href=https://github.com/willyhutw aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://www.linkedin.com/in/yu-lin-hu aria-label=linkedin><span data-feather=linkedin></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://www.willyhu.tw/posts/>Posts</a></li><li class=nav-item><a href=https://www.willyhu.tw/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/willyhutw><span data-feather=github></span></a></li><li class=nav-item><a href=https://www.linkedin.com/in/yu-lin-hu><span data-feather=linkedin></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>pfSense Filterlog Collection</h1><small role=doc-subtitle></small><p class=post-date>April 25, 2024</p><ul class=post-tags><li class=post-tag><a href=https://www.willyhu.tw/tags/pfsense>pfsense</a></li><li class=post-tag><a href=https://www.willyhu.tw/tags/syslog>syslog</a></li><li class=post-tag><a href=https://www.willyhu.tw/tags/fluentd>fluentd</a></li><li class=post-tag><a href=https://www.willyhu.tw/tags/loki>loki</a></li><li class=post-tag><a href=https://www.willyhu.tw/tags/grafana>grafana</a></li></ul></div><div class=post-content><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 528 153"><g transform="translate(8,16)"><path d="M240 0h56" fill="none" stroke="currentColor"/><path d="M432 0h80" fill="none" stroke="currentColor"/><path d="M304 16H432" fill="none" stroke="currentColor"/><path d="M240 32h56" fill="none" stroke="currentColor"/><path d="M432 32h80" fill="none" stroke="currentColor"/><path d="M0 96H80" fill="none" stroke="currentColor"/><path d="M208 96h48" fill="none" stroke="currentColor"/><path d="M256 96h32" fill="none" stroke="currentColor"/><path d="M80 112H2e2" fill="none" stroke="currentColor"/><path d="M0 128H80" fill="none" stroke="currentColor"/><path d="M208 128h80" fill="none" stroke="currentColor"/><path d="M0 96v32" fill="none" stroke="currentColor"/><path d="M80 96v16" fill="none" stroke="currentColor"/><path d="M80 112v16" fill="none" stroke="currentColor"/><path d="M208 96v32" fill="none" stroke="currentColor"/><path d="M240 0V32" fill="none" stroke="currentColor"/><path d="M256 48V96" fill="none" stroke="currentColor"/><path d="M288 96v32" fill="none" stroke="currentColor"/><path d="M296 0V32" fill="none" stroke="currentColor"/><path d="M432 0V16" fill="none" stroke="currentColor"/><path d="M432 16V32" fill="none" stroke="currentColor"/><path d="M512 0V32" fill="none" stroke="currentColor"/><polygon points="208.000000,112.000000 196.000000,106.400002 196.000000,117.599998" fill="currentColor" transform="rotate(0.000000, 200.000000, 112.000000)"/><path d="M256 40v8" fill="none" stroke="currentColor"/><polygon points="272.000000,48.000000 260.000000,42.400002 260.000000,53.599998" fill="currentColor" transform="rotate(270.000000, 256.000000, 48.000000)"/><polygon points="312.000000,16.000000 300.000000,10.400000 300.000000,21.600000" fill="currentColor" transform="rotate(180.000000, 304.000000, 16.000000)"/><text text-anchor="middle" x="16" y="116" fill="currentColor" style="font-size:1em">p</text><text text-anchor="middle" x="24" y="116" fill="currentColor" style="font-size:1em">f</text><text text-anchor="middle" x="32" y="116" fill="currentColor" style="font-size:1em">S</text><text text-anchor="middle" x="40" y="116" fill="currentColor" style="font-size:1em">e</text><text text-anchor="middle" x="48" y="116" fill="currentColor" style="font-size:1em">n</text><text text-anchor="middle" x="56" y="116" fill="currentColor" style="font-size:1em">s</text><text text-anchor="middle" x="64" y="116" fill="currentColor" style="font-size:1em">e</text><text text-anchor="middle" x="112" y="100" fill="currentColor" style="font-size:1em">r</text><text text-anchor="middle" x="120" y="100" fill="currentColor" style="font-size:1em">s</text><text text-anchor="middle" x="128" y="100" fill="currentColor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="100" fill="currentColor" style="font-size:1em">s</text><text text-anchor="middle" x="144" y="100" fill="currentColor" style="font-size:1em">l</text><text text-anchor="middle" x="152" y="100" fill="currentColor" style="font-size:1em">o</text><text text-anchor="middle" x="160" y="100" fill="currentColor" style="font-size:1em">g</text><text text-anchor="middle" x="224" y="116" fill="currentColor" style="font-size:1em">f</text><text text-anchor="middle" x="232" y="116" fill="currentColor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="116" fill="currentColor" style="font-size:1em">u</text><text text-anchor="middle" x="248" y="116" fill="currentColor" style="font-size:1em">e</text><text text-anchor="middle" x="256" y="20" fill="currentColor" style="font-size:1em">L</text><text text-anchor="middle" x="256" y="116" fill="currentColor" style="font-size:1em">n</text><text text-anchor="middle" x="264" y="20" fill="currentColor" style="font-size:1em">o</text><text text-anchor="middle" x="264" y="116" fill="currentColor" style="font-size:1em">t</text><text text-anchor="middle" x="272" y="20" fill="currentColor" style="font-size:1em">k</text><text text-anchor="middle" x="272" y="68" fill="currentColor" style="font-size:1em">w</text><text text-anchor="middle" x="272" y="116" fill="currentColor" style="font-size:1em">d</text><text text-anchor="middle" x="280" y="20" fill="currentColor" style="font-size:1em">i</text><text text-anchor="middle" x="280" y="68" fill="currentColor" style="font-size:1em">r</text><text text-anchor="middle" x="288" y="68" fill="currentColor" style="font-size:1em">i</text><text text-anchor="middle" x="296" y="68" fill="currentColor" style="font-size:1em">t</text><text text-anchor="middle" x="304" y="68" fill="currentColor" style="font-size:1em">e</text><text text-anchor="middle" x="328" y="4" fill="currentColor" style="font-size:1em">d</text><text text-anchor="middle" x="336" y="4" fill="currentColor" style="font-size:1em">a</text><text text-anchor="middle" x="344" y="4" fill="currentColor" style="font-size:1em">t</text><text text-anchor="middle" x="352" y="4" fill="currentColor" style="font-size:1em">a</text><text text-anchor="middle" x="360" y="4" fill="currentColor" style="font-size:1em">s</text><text text-anchor="middle" x="368" y="4" fill="currentColor" style="font-size:1em">o</text><text text-anchor="middle" x="376" y="4" fill="currentColor" style="font-size:1em">u</text><text text-anchor="middle" x="384" y="4" fill="currentColor" style="font-size:1em">r</text><text text-anchor="middle" x="392" y="4" fill="currentColor" style="font-size:1em">c</text><text text-anchor="middle" x="400" y="4" fill="currentColor" style="font-size:1em">e</text><text text-anchor="middle" x="448" y="20" fill="currentColor" style="font-size:1em">G</text><text text-anchor="middle" x="456" y="20" fill="currentColor" style="font-size:1em">r</text><text text-anchor="middle" x="464" y="20" fill="currentColor" style="font-size:1em">a</text><text text-anchor="middle" x="472" y="20" fill="currentColor" style="font-size:1em">f</text><text text-anchor="middle" x="480" y="20" fill="currentColor" style="font-size:1em">a</text><text text-anchor="middle" x="488" y="20" fill="currentColor" style="font-size:1em">n</text><text text-anchor="middle" x="496" y="20" fill="currentColor" style="font-size:1em">a</text></g></svg></div><h2 id=introduction>Introduction</h2><p>This post is about pfSense syslog(especially to filterlog) collection and visualization by using <em><strong>Fluentd</strong></em>, <em><strong>Loki</strong></em> and <em><strong>Grafana</strong></em>. We assume you already have running fluentd, loki and grafana instances. The following instruction won&rsquo;t cover any installation.</p><h2 id=run-fluentd-and-check-the-syslog-of-pfsense>Run fluentd and check the syslog of pfSense</h2><ol><li>First of all, we prepare a very basic fluentd config file (<code>~/fluentd/fluent.conf</code>) for receiving pfsense syslog and printing them out.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;source&gt;
</span></span><span style=display:flex><span>  ### https://docs.fluentd.org/input/syslog
</span></span><span style=display:flex><span>  @type syslog
</span></span><span style=display:flex><span>  port 5141
</span></span><span style=display:flex><span>  bind 0.0.0.0
</span></span><span style=display:flex><span>  &lt;transport udp&gt;
</span></span><span style=display:flex><span>  &lt;/transport&gt;
</span></span><span style=display:flex><span>  &lt;parse&gt;
</span></span><span style=display:flex><span>    message_format rfc5424
</span></span><span style=display:flex><span>  &lt;/parse&gt;
</span></span><span style=display:flex><span>  tag pf
</span></span><span style=display:flex><span>&lt;/source&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;match pf&gt;
</span></span><span style=display:flex><span>  @type stdout
</span></span><span style=display:flex><span>&lt;/match&gt;
</span></span></code></pre></div></li><li>Run fluentd with the config file.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>### https://docs.fluentd.org/installation</span>
</span></span><span style=display:flex><span>/opt/fluent/bin/fluentd -c ~/fluentd/fluent.conf
</span></span></code></pre></div></li><li>Enable and configure the remote logging on pfsense host.<ul><li>Status &#187; System Logs &#187; Settings &#187; General Logging Options<ul><li>Log Message Format: <code>syslog (RFC 5424, with RFC 3339 ...)</code></li></ul></li><li>Status &#187; System Logs &#187; Settings &#187; Remote Logging Options<ul><li>Remote Log Servers: <code>fluentd_listening_address:port (Ex: 192.168.1.99:5141)</code></li><li>Remote Syslog Contents: <code>Firewall Events</code></li></ul></li></ul></li><li>Now you should see the log from pfsense keep comming in.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>2024-04-25 06:09:34.632899000 +0000 pfsense.local0.info: {&#34;host&#34;:&#34;pfsense.willyhu.local&#34;,&#34;ident&#34;:&#34;filterlog&#34;,&#34;pid&#34;:&#34;44226&#34;,&#34;msgid&#34;:&#34;-&#34;,&#34;extradata&#34;:&#34;-&#34;,&#34;message&#34;:&#34;4,,,1000000103,pppoe0,match,block,in,4,0x0,,242,26160,0,none,6,tcp,44,89.248.165.17,125.229.96.130,44961,30129,0,S,3258086147,,1025,,mss&#34;}
</span></span><span style=display:flex><span>2024-04-25 06:09:41.934155000 +0000 pfsense.local0.info: {&#34;host&#34;:&#34;pfsense.willyhu.local&#34;,&#34;ident&#34;:&#34;filterlog&#34;,&#34;pid&#34;:&#34;44226&#34;,&#34;msgid&#34;:&#34;-&#34;,&#34;extradata&#34;:&#34;-&#34;,&#34;message&#34;:&#34;4,,,1000000103,pppoe0,match,block,in,4,0x0,,233,61911,0,none,6,tcp,40,45.141.87.109,125.229.96.130,44210,5040,0,S,246121189,,1024,,&#34;}
</span></span><span style=display:flex><span>2024-04-25 06:09:42.959281000 +0000 pfsense.local0.info: {&#34;host&#34;:&#34;pfsense.willyhu.local&#34;,&#34;ident&#34;:&#34;filterlog&#34;,&#34;pid&#34;:&#34;44226&#34;,&#34;msgid&#34;:&#34;-&#34;,&#34;extradata&#34;:&#34;-&#34;,&#34;message&#34;:&#34;4,,,1000000103,pppoe0,match,block,in,4,0x0,,107,19362,0,DF,6,tcp,52,177.229.216.18,125.229.96.130,51305,445,0,S,1581211380,,8192,,mss;nop;wscale;nop;nop;sackOK&#34;}
</span></span></code></pre></div></li><li>As we&rsquo;ve configured the message format(rfc5424) in fluentd config, it has already extracted several fields and values for us. However, as you can see. We still have to parse the <code>message</code> field before insert them into Loki server.<ul><li>host: <code>pfsense.willyhu.local</code></li><li>ident: <code>filterlog</code></li><li>pid: <code>44226</code></li><li>msgid: <code>-</code></li><li>extradata: <code>-</code></li><li>message: <code>4,,,1000000103,pppoe0,match,block,in,4,0x0,,111,23330,0,DF,6,tcp,52,115.73.209.120,125.229.96.130,56735,445,0,S,2152994813,,8192,,mss;nop;wscale;nop;nop;sackOK</code></li></ul></li></ol><h2 id=parsing-the-raw-message-of-filterlog>Parsing the raw message of filterlog</h2><p>Every kind of log has its own format. In this case, we can find the very detailed explanation of filterlog format at <a href=https://docs.netgate.com/pfsense/en/latest/monitoring/logs/raw-filter-format.html>pfsense official document</a>. That <code>&lt;CSV data></code> in the document is actually the value of the <code>message</code> field. So, let&rsquo;s break it down!</p><ol><li>Install extra fluentd plugins: <code>rewrite_tag_filter</code> and <code>filter_record_modifier</code>.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo /opt/fluent/bin/fluent-gem install fluent-plugin-rewrite-tag-filter
</span></span><span style=display:flex><span>sudo /opt/fluent/bin/fluent-gem install fluent-plugin-record-modifier
</span></span></code></pre></div></li><li>Add following filters to <code>~/fluentd/fluent.conf</code> after <code>&lt;source></code> section.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>### add log_type field
</span></span><span style=display:flex><span>&lt;filter pf&gt;
</span></span><span style=display:flex><span>  @type record_modifier
</span></span><span style=display:flex><span>  &lt;record&gt;
</span></span><span style=display:flex><span>    log_type ${record[&#39;ident&#39;]}
</span></span><span style=display:flex><span>  &lt;/record&gt;
</span></span><span style=display:flex><span>&lt;/filter&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### rewrite tag: pf.${log_type}
</span></span><span style=display:flex><span>&lt;match pf&gt;
</span></span><span style=display:flex><span>  @type rewrite_tag_filter
</span></span><span style=display:flex><span>  &lt;rule&gt;
</span></span><span style=display:flex><span>    key log_type
</span></span><span style=display:flex><span>    pattern ^(.+)$
</span></span><span style=display:flex><span>    tag ${tag}.$1
</span></span><span style=display:flex><span>  &lt;/rule&gt;
</span></span><span style=display:flex><span>&lt;/match&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### parsing ip_version and protocol_text for later tag rewrite.
</span></span><span style=display:flex><span>&lt;filter pf.filterlog&gt;
</span></span><span style=display:flex><span>  @type parser
</span></span><span style=display:flex><span>  key_name message
</span></span><span style=display:flex><span>  reserve_data true
</span></span><span style=display:flex><span>  reserve_time true
</span></span><span style=display:flex><span>  &lt;parse&gt;
</span></span><span style=display:flex><span>    @type regexp
</span></span><span style=display:flex><span>    expression /^(?:[^,]*,){8}(?&lt;ip_version&gt;[^,]*),(?:[^,]*,){7}(?&lt;protocol_text&gt;[^,]*)/
</span></span><span style=display:flex><span>  &lt;/parse&gt;
</span></span><span style=display:flex><span>&lt;/filter&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### rewrite tag: pf.${ident}.${ip_version}
</span></span><span style=display:flex><span>&lt;match pf.filterlog&gt;
</span></span><span style=display:flex><span>  @type rewrite_tag_filter
</span></span><span style=display:flex><span>  &lt;rule&gt;
</span></span><span style=display:flex><span>    key ip_version
</span></span><span style=display:flex><span>    pattern ^(.+)$
</span></span><span style=display:flex><span>    tag ${tag}.$1
</span></span><span style=display:flex><span>  &lt;/rule&gt;
</span></span><span style=display:flex><span>&lt;/match&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### rewrite tag: pf.${ident}.${ip_version}.${protocol_text}
</span></span><span style=display:flex><span>&lt;match pf.filterlog.*&gt;
</span></span><span style=display:flex><span>  @type rewrite_tag_filter
</span></span><span style=display:flex><span>  &lt;rule&gt;
</span></span><span style=display:flex><span>    key protocol_text
</span></span><span style=display:flex><span>    pattern ^(.+)$
</span></span><span style=display:flex><span>    tag ${tag}.$1
</span></span><span style=display:flex><span>  &lt;/rule&gt;
</span></span><span style=display:flex><span>&lt;/match&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### parsing filterlog: ipv4/tcp
</span></span><span style=display:flex><span>&lt;filter pf.filterlog.4.tcp&gt;
</span></span><span style=display:flex><span>  @type parser
</span></span><span style=display:flex><span>  key_name message
</span></span><span style=display:flex><span>  reserve_time true
</span></span><span style=display:flex><span>  &lt;parse&gt;
</span></span><span style=display:flex><span>    @type regexp
</span></span><span style=display:flex><span>    expression /^(?&lt;rule_number&gt;[^,]*),(?&lt;sub_rule_number&gt;[^,]*),(?&lt;anchor&gt;[^,]*),(?&lt;tracker&gt;[^,]*),(?&lt;real_interface&gt;[^,]*),(?&lt;reason&gt;[^,]*),(?&lt;action&gt;[^,]*),(?&lt;direction&gt;[^,]*),(?&lt;ip_version&gt;[^,]*),(?&lt;tos&gt;[^,]*),(?&lt;ecn&gt;[^,]*),(?&lt;ttl&gt;[^,]*),(?&lt;id&gt;[^,]*),(?&lt;offset&gt;[^,]*),(?&lt;flags&gt;[^,]*),(?&lt;protocol_id&gt;[^,]*),(?&lt;protocol_text&gt;[^,]*),(?&lt;length&gt;[^,]*),(?&lt;source_address&gt;[^,]*),(?&lt;destination_address&gt;[^,]*),(?&lt;source_port&gt;[^,]*),(?&lt;destination_port&gt;[^,]*),(?&lt;data_length&gt;[^,]*),(?&lt;tcp_flags&gt;[^,]*),(?&lt;sequence_number&gt;[^,]*),(?&lt;ack_number&gt;[^,]*),(?&lt;tcp_window&gt;[^,]*),(?&lt;urg&gt;[^,]*),(?&lt;tcp_options&gt;[^,]*)/
</span></span><span style=display:flex><span>  &lt;/parse&gt;
</span></span><span style=display:flex><span>&lt;/filter&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### parsing filterlog: ipv4/udp
</span></span><span style=display:flex><span>&lt;filter pf.filterlog.4.udp&gt;
</span></span><span style=display:flex><span>  @type parser
</span></span><span style=display:flex><span>  key_name message
</span></span><span style=display:flex><span>  reserve_time true
</span></span><span style=display:flex><span>  &lt;parse&gt;
</span></span><span style=display:flex><span>    @type regexp
</span></span><span style=display:flex><span>    expression /^(?&lt;rule_number&gt;[^,]*),(?&lt;sub_rule_number&gt;[^,]*),(?&lt;anchor&gt;[^,]*),(?&lt;tracker&gt;[^,]*),(?&lt;real_interface&gt;[^,]*),(?&lt;reason&gt;[^,]*),(?&lt;action&gt;[^,]*),(?&lt;direction&gt;[^,]*),(?&lt;ip_version&gt;[^,]*),(?&lt;tos&gt;[^,]*),(?&lt;ecn&gt;[^,]*),(?&lt;ttl&gt;[^,]*),(?&lt;id&gt;[^,]*),(?&lt;offset&gt;[^,]*),(?&lt;flags&gt;[^,]*),(?&lt;protocol_id&gt;[^,]*),(?&lt;protocol_text&gt;[^,]*),(?&lt;length&gt;[^,]*),(?&lt;source_address&gt;[^,]*),(?&lt;destination_address&gt;[^,]*),(?&lt;source_port&gt;[^,]*),(?&lt;destination_port&gt;[^,]*),(?&lt;data_length&gt;[^,]*)/
</span></span><span style=display:flex><span>  &lt;/parse&gt;
</span></span><span style=display:flex><span>&lt;/filter&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### parsing filterlog: ipv6/tcp
</span></span><span style=display:flex><span>&lt;filter pf.filterlog.6.tcp&gt;
</span></span><span style=display:flex><span>  @type parser
</span></span><span style=display:flex><span>  key_name message
</span></span><span style=display:flex><span>  reserve_time true
</span></span><span style=display:flex><span>  &lt;parse&gt;
</span></span><span style=display:flex><span>    @type regexp
</span></span><span style=display:flex><span>    expression /^(?&lt;rule_number&gt;[^,]*),(?&lt;sub_rule_number&gt;[^,]*),(?&lt;anchor&gt;[^,]*),(?&lt;tracker&gt;[^,]*),(?&lt;real_interface&gt;[^,]*),(?&lt;reason&gt;[^,]*),(?&lt;action&gt;[^,]*),(?&lt;direction&gt;[^,]*),(?&lt;ip_version&gt;[^,]*),(?&lt;class&gt;[^,]*),(?&lt;flow_label&gt;[^,]*),(?&lt;hop_limit&gt;[^,]*),(?&lt;protocol_text&gt;[^,]*),(?&lt;protocol_id&gt;[^,]*),(?&lt;length&gt;[^,]*),(?&lt;source_address&gt;[^,]*),(?&lt;destination_address&gt;[^,]*),(?&lt;source_port&gt;[^,]*),(?&lt;destination_port&gt;[^,]*),(?&lt;data_length&gt;[^,]*),(?&lt;tcp_flags&gt;[^,]*),(?&lt;sequence_number&gt;[^,]*),(?&lt;ack_number&gt;[^,]*),(?&lt;tcp_window&gt;[^,]*),(?&lt;urg&gt;[^,]*),(?&lt;tcp_options&gt;[^,]*)/
</span></span><span style=display:flex><span>  &lt;/parse&gt;
</span></span><span style=display:flex><span>&lt;/filter&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### parsing filterlog: ipv6/udp
</span></span><span style=display:flex><span>&lt;filter pf.filterlog.6.udp&gt;
</span></span><span style=display:flex><span>  @type parser
</span></span><span style=display:flex><span>  key_name message
</span></span><span style=display:flex><span>  reserve_time true
</span></span><span style=display:flex><span>  &lt;parse&gt;
</span></span><span style=display:flex><span>    @type regexp
</span></span><span style=display:flex><span>    expression /^(?&lt;rule_number&gt;[^,]*),(?&lt;sub_rule_number&gt;[^,]*),(?&lt;anchor&gt;[^,]*),(?&lt;tracker&gt;[^,]*),(?&lt;real_interface&gt;[^,]*),(?&lt;reason&gt;[^,]*),(?&lt;action&gt;[^,]*),(?&lt;direction&gt;[^,]*),(?&lt;ip_version&gt;[^,]*),(?&lt;class&gt;[^,]*),(?&lt;flow_label&gt;[^,]*),(?&lt;hop_limit&gt;[^,]*),(?&lt;protocol_text&gt;[^,]*),(?&lt;protocol_id&gt;[^,]*),(?&lt;length&gt;[^,]*),(?&lt;source_address&gt;[^,]*),(?&lt;destination_address&gt;[^,]*),(?&lt;source_port&gt;[^,]*),(?&lt;destination_port&gt;[^,]*),(?&lt;data_length&gt;[^,]*)/
</span></span><span style=display:flex><span>  &lt;/parse&gt;
</span></span><span style=display:flex><span>&lt;/filter&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### remove unused fields in this case
</span></span><span style=display:flex><span>&lt;filter pf.**&gt;
</span></span><span style=display:flex><span>  @type record_modifier
</span></span><span style=display:flex><span>  remove_keys message,host,pri,ident,pid,msgid,extradata,rule_number,sub_rule_number,anchor,tracker,reason,tos,ecn,ttl,id,offset,flags,protocol_id,length,source_port,data_length,sequence_number,ack_number,tcp_window,urg,tcp_options,class,flow_label,hop_limit
</span></span><span style=display:flex><span>&lt;/filter&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>### print out results
</span></span><span style=display:flex><span>&lt;match pf.**&gt;
</span></span><span style=display:flex><span>  @type stdout
</span></span><span style=display:flex><span>&lt;/match&gt;
</span></span></code></pre></div></li><li>Re-run fluentd again you should see the message has been extracted (exclude the fields we deleted) to key/value pair.<ul><li>real_interface: <code>pppoe0</code></li><li>action: <code>block</code></li><li>direction: <code>in</code></li><li>ip_version: <code>4</code></li><li>protocol_text: <code>tcp</code></li><li>source_address: <code>157.245.252.5</code></li><li>destination_address: <code>125.229.96.130</code></li><li>destination_port: <code>22</code></li><li>tcp_flags: <code>S</code></li><li>log_type: <code>filterlog</code></li></ul></li></ol><h2 id=ip-address-lookup---the-geolocation>IP address lookup - The Geolocation</h2><p>We can find more information from ip address. It&rsquo;s helpful for further aggregation and visualization.</p><ol><li>Install extra fluentd <code>geoip</code> plugin.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>### https://github.com/y-ken/fluent-plugin-geoip?tab=readme-ov-file#dependency</span>
</span></span><span style=display:flex><span>sudo /opt/fluent/bin/fluent-gem install fluent-plugin-geoip
</span></span></code></pre></div></li><li>Download the geoip database.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo curl -sSfL -o /opt/GeoLite2-City.mmdb https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb
</span></span></code></pre></div></li><li>Add geoip filter below to <code>~/fluentd/fluent.conf</code> before the <code>record_modifier</code> section.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;filter pf.filterlog.**&gt;
</span></span><span style=display:flex><span>  @type geoip
</span></span><span style=display:flex><span>  geoip_lookup_keys source_address,destination_address
</span></span><span style=display:flex><span>  geoip2_database /opt/GeoLite2-City.mmdb
</span></span><span style=display:flex><span>  &lt;record&gt;
</span></span><span style=display:flex><span>    source_country ${country.names.en[&#34;source_address&#34;]}
</span></span><span style=display:flex><span>    source_country_code ${country.iso_code[&#34;source_address&#34;]}
</span></span><span style=display:flex><span>    source_city ${city.names.en[&#34;source_address&#34;]}
</span></span><span style=display:flex><span>    destination_country ${country.names.en[&#34;destination_address&#34;]}
</span></span><span style=display:flex><span>    destination_country_code ${country.iso_code[&#34;destination_address&#34;]}
</span></span><span style=display:flex><span>    destination_city ${city.names.en[&#34;destination_address&#34;]}
</span></span><span style=display:flex><span>  &lt;/record&gt;
</span></span><span style=display:flex><span>&lt;/filter&gt;
</span></span></code></pre></div></li><li>Re-run fluentd you should see extra 6 fields that we&rsquo;ve extracted through geoip filter:<ul><li>source_country: <code>The Netherlands</code></li><li>source_country_code: <code>NL</code></li><li>source_city: <code>Amsterdam</code></li><li>destination_country: <code>Taiwan</code></li><li>destination_country_code: <code>TW</code></li><li>destination_city: <code>Zhongli District</code></li></ul></li></ol><h2 id=writing-logs-to-loki>Writing logs to Loki</h2><p>We&rsquo;ve done a lot so far. Time to add an output and send logs to our lightweight log storage: <em><strong>Loki</strong></em>.</p><ol><li>Install extra fluentd <code>fluent-plugin-grafana-loki</code> plugin.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>### https://grafana.com/docs/loki/latest/send-data/fluentd/</span>
</span></span><span style=display:flex><span>sudo /opt/fluent/bin/fluent-gem install fluent-plugin-grafana-loki
</span></span></code></pre></div></li><li>Add output config below to the bottom of <code>~/fluentd/fluent.conf</code> and don&rsquo;t forget to update the address of the loki server. The whole fluentd config for this case can be downloaded <a href=/files/fluent-pfsense-filterlog-loki.conf>HERE</a>.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;match pf.**&gt;
</span></span><span style=display:flex><span>  @type loki
</span></span><span style=display:flex><span>  url &#34;http://loki:3100&#34;
</span></span><span style=display:flex><span>  include_thread_label false
</span></span><span style=display:flex><span>  drop_single_key true
</span></span><span style=display:flex><span>  &lt;label&gt;
</span></span><span style=display:flex><span>    log_type $.log_type
</span></span><span style=display:flex><span>    real_interface $.real_interface
</span></span><span style=display:flex><span>    direction $.direction
</span></span><span style=display:flex><span>    ip_version $.ip_version
</span></span><span style=display:flex><span>    protocol_text $.protocol_text
</span></span><span style=display:flex><span>    action $.action
</span></span><span style=display:flex><span>    source_address $.source_address
</span></span><span style=display:flex><span>    source_country $.source_country
</span></span><span style=display:flex><span>    source_country_code $.source_country_code
</span></span><span style=display:flex><span>    destination_address $.destination_address
</span></span><span style=display:flex><span>    destination_country $.destination_country
</span></span><span style=display:flex><span>    destination_country_code $.destination_country_code
</span></span><span style=display:flex><span>    destination_port $.destination_port
</span></span><span style=display:flex><span>  &lt;/label&gt;
</span></span><span style=display:flex><span>  &lt;buffer&gt;
</span></span><span style=display:flex><span>    flush_interval 10s
</span></span><span style=display:flex><span>    flush_at_shutdown true
</span></span><span style=display:flex><span>  &lt;/buffer&gt;
</span></span><span style=display:flex><span>&lt;/match&gt;
</span></span></code></pre></div></li></ol><h2 id=visualization---grafana>Visualization - Grafana</h2><p>Once logs have been written into Loki with proper labels. We can easily create a dashboard in Grafana with Loki datasource. Here is an example dashboard of pfSense filterlog in this case. As usual, try <a href=/files/pfsense-filterlog-20240425-2228.json>download</a> and import into your own Grafana server.</p><p><img src=/images/pfsense-filterlog-grafana.png alt="The Grafana dashboard of pfSense filterlog."></p></div><div class=prev-next></div></div></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>